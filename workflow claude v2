{
  "name": "ğŸ¤– Profesyonel WhatsApp + Instagram Chatbot System v2.0",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸš€ CHATBOT WORKFLOW SÄ°STEMÄ°\n\n### ğŸ“‹ GENEL BÄ°LGÄ°\n**Versiyon:** 2.0\n**Platform:** WhatsApp & Instagram\n**AmaÃ§:** Ã‡ok amaÃ§lÄ± iÅŸletme chatbot sistemi\n\n### ğŸ”§ GEREKLÄ° AYARLAR\n\n#### Environment Variables:\n- `VERIFY_TOKEN`: Meta webhook doÄŸrulama token'Ä±\n- `META_APP_SECRET`: Facebook App Secret (imza doÄŸrulama iÃ§in)\n- `META_WA_PHONE_ID`: WhatsApp Phone Number ID\n- `IG_BUSINESS_ID`: Instagram Business Account ID\n- `OPENAI_API_KEY`: OpenAI API anahtarÄ±\n- `SUPPORT_TEAM_WEBHOOK`: Destek ekibi bildirim URL'i\n\n#### VeritabanÄ± TablolarÄ±:\n```sql\n-- MÃ¼ÅŸteri kayÄ±tlarÄ±\nCREATE TABLE contacts (\n  id SERIAL PRIMARY KEY,\n  platform VARCHAR(20),\n  user_id VARCHAR(100),\n  name VARCHAR(200),\n  phone VARCHAR(50),\n  created_at TIMESTAMP DEFAULT NOW()\n);\n\n-- Mesaj geÃ§miÅŸi\nCREATE TABLE messages (\n  id SERIAL PRIMARY KEY,\n  platform VARCHAR(20),\n  user_id VARCHAR(100),\n  direction VARCHAR(10),\n  text TEXT,\n  intent VARCHAR(50),\n  created_at TIMESTAMP DEFAULT NOW()\n);\n\n-- MÃ¼ÅŸteri hafÄ±zasÄ±\nCREATE TABLE customer_memory (\n  user_id VARCHAR(100) PRIMARY KEY,\n  preferences TEXT,\n  last_order TEXT,\n  notes TEXT,\n  updated_at TIMESTAMP DEFAULT NOW()\n);\n\n-- Destek talepleri\nCREATE TABLE support_tickets (\n  id SERIAL PRIMARY KEY,\n  user_id VARCHAR(100),\n  issue TEXT,\n  priority VARCHAR(20),\n  status VARCHAR(20) DEFAULT 'open',\n  created_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n### ğŸ“Š WORKFLOW AKIÅI\n1. **Webhook AlÄ±mÄ±** â†’ GÃ¼venlik KontrolÃ¼\n2. **Mesaj Ä°ÅŸleme** â†’ Normalizasyon\n3. **AI Analizi** â†’ Intent Tespiti\n4. **Aksiyon** â†’ YanÄ±t GÃ¶nderimi\n5. **KayÄ±t** â†’ VeritabanÄ± & HafÄ±za",
        "height": 800,
        "width": 600
      },
      "id": "note-001",
      "name": "ğŸ“š DOKÃœMANTASYON",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-200, 0]
    },

    {
      "parameters": {
        "content": "## ğŸ” BÃ–LÃœM 1: WEBHOOK DOÄRULAMA\n\n### Bu bÃ¶lÃ¼mÃ¼n gÃ¶revi:\nMeta (Facebook) webhook'larÄ±nÄ± doÄŸrulamak\n\n### NasÄ±l Ã§alÄ±ÅŸÄ±r:\n1. Meta ilk kurulumda GET isteÄŸi gÃ¶nderir\n2. `hub.verify_token` kontrolÃ¼ yapÄ±lÄ±r\n3. DoÄŸruysa `hub.challenge` geri dÃ¶ndÃ¼rÃ¼lÃ¼r\n4. YanlÄ±ÅŸsa 403 hatasÄ± verilir\n\n### âš ï¸ Ã–NEMLÄ°:\n- VERIFY_TOKEN'Ä± gÃ¼Ã§lÃ¼ seÃ§in\n- Meta Business Manager'da aynÄ± token'Ä± girin",
        "height": 300,
        "width": 400
      },
      "id": "note-002",
      "name": "BÃ¶lÃ¼m 1 AÃ§Ä±klama",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [100, 0]
    },

    {
      "parameters": {
        "path": "webhook/meta-verify",
        "methods": ["GET"],
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-verify",
      "name": "ğŸ”“ Meta Webhook DoÄŸrulama",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [520, 100]
    },

    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.query['hub.verify_token']}}",
              "operation": "equals",
              "value2": "={{$env.VERIFY_TOKEN}}"
            }
          ]
        }
      },
      "id": "if-verify",
      "name": "Token DoÄŸru mu?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [720, 100]
    },

    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "response",
              "value": "={{$json.query['hub.challenge']}}"
            }
          ]
        }
      },
      "id": "set-challenge",
      "name": "Challenge HazÄ±rla",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [920, 60]
    },

    {
      "parameters": {
        "responseBody": "={{$json.response}}",
        "responseCode": 200
      },
      "id": "respond-200",
      "name": "âœ… DoÄŸrulama BaÅŸarÄ±lÄ±",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1120, 60]
    },

    {
      "parameters": {
        "responseBody": "Unauthorized",
        "responseCode": 403
      },
      "id": "respond-403",
      "name": "âŒ DoÄŸrulama BaÅŸarÄ±sÄ±z",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [920, 140]
    },

    {
      "parameters": {
        "content": "## ğŸ“¨ BÃ–LÃœM 2: MESAJ ALIMI\n\n### Bu bÃ¶lÃ¼mÃ¼n gÃ¶revi:\nWhatsApp ve Instagram mesajlarÄ±nÄ± almak\n\n### GÃ¼venlik KatmanlarÄ±:\n1. **HMAC Ä°mza DoÄŸrulama**: Meta'nÄ±n gÃ¶nderdiÄŸi imza kontrol edilir\n2. **Rate Limiting**: AynÄ± kullanÄ±cÄ±dan fazla istek engellenir\n3. **Content Validation**: ZararlÄ± iÃ§erik kontrolÃ¼\n\n### Desteklenen Mesaj Tipleri:\n- âœ… Metin mesajlarÄ±\n- âœ… Buton yanÄ±tlarÄ±\n- âœ… Quick reply'ler\n- âœ… Emoji reaksiyonlarÄ±\n- âš ï¸ Medya mesajlarÄ± (opsiyonel)",
        "height": 350,
        "width": 400
      },
      "id": "note-003",
      "name": "BÃ¶lÃ¼m 2 AÃ§Ä±klama",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [100, 400]
    },

    {
      "parameters": {
        "path": "webhook/messages",
        "methods": ["POST"],
        "responseMode": "responseNode",
        "options": {
          "rawBody": true
        }
      },
      "id": "webhook-messages",
      "name": "ğŸ“¥ Mesaj Webhook'u",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [520, 500]
    },

    {
      "parameters": {
        "jsCode": "// HMAC-SHA256 imza doÄŸrulama\nconst crypto = require('crypto');\n\n// Ã‡evre deÄŸiÅŸkenlerini al\nconst appSecret = $env.META_APP_SECRET;\nif (!appSecret) {\n  throw new Error('META_APP_SECRET tanÄ±mlÄ± deÄŸil!');\n}\n\n// Header'dan imzayÄ± al\nconst signature = $input.first().json.headers?.['x-hub-signature-256'] || '';\nif (!signature) {\n  return [{json: {valid: false, error: 'Ä°mza header bulunamadÄ±'}}];\n}\n\n// Raw body'yi al\nconst rawBody = $input.first().json.body;\nconst bodyString = typeof rawBody === 'string' ? rawBody : JSON.stringify(rawBody);\n\n// Ä°mzayÄ± hesapla\nconst expectedSignature = 'sha256=' + crypto\n  .createHmac('sha256', appSecret)\n  .update(bodyString)\n  .digest('hex');\n\n// KarÅŸÄ±laÅŸtÄ±r\nconst valid = signature === expectedSignature;\n\n// Log iÃ§in detay ekle\nif (!valid) {\n  console.log('Ä°mza doÄŸrulama hatasÄ±:', {\n    received: signature.substring(0, 20) + '...',\n    expected: expectedSignature.substring(0, 20) + '...'\n  });\n}\n\nreturn [{json: {\n  valid,\n  body: rawBody,\n  timestamp: new Date().toISOString()\n}}];"
      },
      "id": "verify-signature",
      "name": "ğŸ”’ Ä°mza DoÄŸrulama",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [720, 500]
    },

    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.valid}}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-signature",
      "name": "Ä°mza GeÃ§erli mi?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [920, 500]
    },

    {
      "parameters": {
        "jsCode": "// Gelen webhook payload'Ä±nÄ± normalize et\nconst data = $input.first().json.body;\n\n// Platform tespiti\nlet platform = 'unknown';\nif (data.object === 'whatsapp_business_account') platform = 'whatsapp';\nelse if (data.object === 'instagram') platform = 'instagram';\n\n// BoÅŸ mesaj kontrolÃ¼\nconst entry = data.entry?.[0];\nif (!entry) {\n  return [{json: {skip: true, reason: 'No entry data'}}];\n}\n\nconst changes = entry.changes?.[0];\nif (!changes) {\n  return [{json: {skip: true, reason: 'No changes data'}}];\n}\n\nconst value = changes.value;\n\n// WhatsApp mesaj Ã§Ä±karÄ±mÄ±\nif (platform === 'whatsapp') {\n  const message = value.messages?.[0];\n  if (!message) {\n    return [{json: {skip: true, reason: 'No message'}}];\n  }\n  \n  // Mesaj tipini belirle\n  let messageType = 'unknown';\n  let content = '';\n  let mediaUrl = null;\n  \n  if (message.text) {\n    messageType = 'text';\n    content = message.text.body;\n  } else if (message.button) {\n    messageType = 'button_reply';\n    content = message.button.text;\n  } else if (message.interactive) {\n    messageType = 'interactive';\n    content = message.interactive.button_reply?.title || \n              message.interactive.list_reply?.title || '';\n  } else if (message.image) {\n    messageType = 'image';\n    mediaUrl = message.image.id; // Media ID for download\n  }\n  \n  // KullanÄ±cÄ± bilgilerini al\n  const contact = value.contacts?.[0] || {};\n  \n  return [{json: {\n    platform,\n    messageId: message.id,\n    userId: message.from,\n    userName: contact.profile?.name || 'Bilinmeyen',\n    messageType,\n    content,\n    mediaUrl,\n    timestamp: message.timestamp,\n    context: message.context, // Reply to message info\n    skip: false\n  }}];\n}\n\n// Instagram mesaj Ã§Ä±karÄ±mÄ±\nif (platform === 'instagram') {\n  const messaging = value.messaging?.[0];\n  if (!messaging) {\n    return [{json: {skip: true, reason: 'No messaging data'}}];\n  }\n  \n  const message = messaging.message;\n  if (!message) {\n    return [{json: {skip: true, reason: 'No message'}}];\n  }\n  \n  return [{json: {\n    platform,\n    messageId: message.mid,\n    userId: messaging.sender.id,\n    userName: 'Instagram User',\n    messageType: 'text',\n    content: message.text || '',\n    mediaUrl: message.attachments?.[0]?.payload?.url,\n    timestamp: messaging.timestamp,\n    skip: false\n  }}];\n}\n\nreturn [{json: {skip: true, reason: 'Unknown platform'}}];"
      },
      "id": "normalize-message",
      "name": "ğŸ”„ Mesaj Normalizasyon",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 460]
    },

    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.skip}}",
              "value2": false
            }
          ]
        }
      },
      "id": "if-process",
      "name": "Ä°ÅŸlenecek Mesaj mÄ±?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1320, 460]
    },

    {
      "parameters": {
        "content": "## ğŸ§  BÃ–LÃœM 3: AI Ä°ÅLEME\n\n### Bu bÃ¶lÃ¼mÃ¼n gÃ¶revi:\nMesajlarÄ± AI ile analiz edip yanÄ±t Ã¼retmek\n\n### AI KatmanlarÄ±:\n\n#### 1. BaÄŸlam HazÄ±rlama\n- Son 10 mesaj geÃ§miÅŸi\n- MÃ¼ÅŸteri tercihleri\n- Ä°ÅŸletme bilgileri\n\n#### 2. Intent Tespiti\n- GREETING: Selamlama\n- QUESTION: Soru\n- COMPLAINT: Åikayet\n- ORDER: SipariÅŸ\n- SUPPORT: Destek talebi\n\n#### 3. YanÄ±t Ãœretimi\n- KiÅŸiselleÅŸtirilmiÅŸ\n- BaÄŸlama uygun\n- Ä°ÅŸletme tonunda\n\n### ğŸ¯ Ã–zel Durumlar:\n- KÄ±zgÄ±n mÃ¼ÅŸteri â†’ Empati modu\n- KarmaÅŸÄ±k soru â†’ Destek yÃ¶nlendirme\n- SipariÅŸ â†’ Sistem entegrasyonu",
        "height": 500,
        "width": 400
      },
      "id": "note-004",
      "name": "BÃ¶lÃ¼m 3 AÃ§Ä±klama",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [1500, 300]
    },

    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "messages",
        "limit": 10,
        "sort": {
          "values": [
            {
              "column": "created_at",
              "direction": "DESC"
            }
          ]
        },
        "where": {
          "values": [
            {
              "column": "user_id",
              "value": "={{$json.userId}}"
            }
          ]
        },
        "options": {}
      },
      "id": "get-history",
      "name": "ğŸ“œ GeÃ§miÅŸ MesajlarÄ± Al",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1920, 400]
    },

    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "customer_memory",
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "user_id",
              "value": "={{$('normalize-message').item.json.userId}}"
            }
          ]
        },
        "options": {}
      },
      "id": "get-memory",
      "name": "ğŸ§  MÃ¼ÅŸteri HafÄ±zasÄ±",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1920, 500]
    },

    {
      "parameters": {
        "jsCode": "// TÃ¼m verileri topla\nconst currentMessage = $('normalize-message').item.json;\nconst history = $('get-history').all().map(item => item.json);\nconst memory = $('get-memory').first()?.json || {};\n\n// Ä°ÅŸletme bilgilerini al (environment'tan veya DB'den)\nconst businessInfo = {\n  name: $env.BUSINESS_NAME || 'Ä°ÅŸletmemiz',\n  type: $env.BUSINESS_TYPE || 'hizmet saÄŸlayÄ±cÄ±',\n  workHours: $env.WORK_HOURS || '09:00-18:00',\n  tone: $env.CHAT_TONE || 'profesyonel ve samimi'\n};\n\n// KonuÅŸma geÃ§miÅŸini formatla\nconst conversationHistory = history\n  .reverse()\n  .map(msg => `${msg.direction === 'in' ? 'MÃ¼ÅŸteri' : 'Asistan'}: ${msg.text}`)\n  .join('\\n');\n\n// MÃ¼ÅŸteri profilini oluÅŸtur\nconst customerProfile = {\n  name: currentMessage.userName,\n  preferences: memory.preferences || 'Bilinmiyor',\n  lastOrder: memory.last_order || 'Yok',\n  notes: memory.notes || ''\n};\n\n// System prompt'u hazÄ±rla\nconst systemPrompt = `Sen ${businessInfo.name} adÄ±na Ã§alÄ±ÅŸan bir mÃ¼ÅŸteri asistanÄ±sÄ±n.\n\nÄ°ÅŸletme Tipi: ${businessInfo.type}\nÃ‡alÄ±ÅŸma Saatleri: ${businessInfo.workHours}\nÄ°letiÅŸim Tonu: ${businessInfo.tone}\n\nMÃ¼ÅŸteri Profili:\n- Ä°sim: ${customerProfile.name}\n- Tercihler: ${customerProfile.preferences}\n- Son SipariÅŸ: ${customerProfile.lastOrder}\n- Notlar: ${customerProfile.notes}\n\nKurallar:\n1. Her zaman kibar ve yardÄ±msever ol\n2. KÄ±sa ve net yanÄ±tlar ver\n3. Emoji kullan ama abartma\n4. MÃ¼ÅŸteriyi ismiyle hitap et\n5. Ã‡Ã¶zemediÄŸin konularda destek ekibine yÃ¶nlendir\n6. Fiyat ve stok bilgisi istenen durumlarda gÃ¼ncel bilgi iÃ§in kontrol gerektiÄŸini belirt\n\nGeÃ§miÅŸ KonuÅŸma:\n${conversationHistory || 'Ä°lk konuÅŸma'}\n\nÅu mesaja yanÄ±t ver ve MUTLAKA yanÄ±tÄ±nÄ±n sonuna ÅŸu JSON formatÄ±nÄ± ekle:\n{\"intent\": \"GREETING|QUESTION|ORDER|COMPLAINT|SUPPORT\", \"confidence\": 0.0-1.0, \"requiresHuman\": true/false, \"sentiment\": \"positive|neutral|negative\"}`;\n\nconst userMessage = currentMessage.content;\n\nreturn [{json: {\n  systemPrompt,\n  userMessage,\n  currentMessage,\n  businessInfo,\n  customerProfile\n}}];"
      },
      "id": "prepare-context",
      "name": "ğŸ“ AI BaÄŸlamÄ± HazÄ±rla",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2120, 450]
    },

    {
      "parameters": {
        "resource": "chat",
        "model": "gpt-4o-mini",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "={{$json.systemPrompt}}"
            },
            {
              "role": "user",
              "content": "={{$json.userMessage}}"
            }
          ]
        },
        "options": {
          "temperature": 0.7,
          "maxTokens": 500,
          "topP": 0.9
        }
      },
      "id": "ai-generate",
      "name": "ğŸ¤– AI YanÄ±t Ãœret",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.4,
      "position": [2320, 450]
    },

    {
      "parameters": {
        "jsCode": "// AI yanÄ±tÄ±nÄ± parse et\nconst aiResponse = $input.first().json.choices[0].message.content;\n\n// JSON metadata'yÄ± ayÄ±kla\nconst jsonMatch = aiResponse.match(/\\{[^}]+\\}$/);\nlet metadata = {\n  intent: 'UNKNOWN',\n  confidence: 0.5,\n  requiresHuman: false,\n  sentiment: 'neutral'\n};\n\nlet cleanResponse = aiResponse;\n\nif (jsonMatch) {\n  try {\n    metadata = JSON.parse(jsonMatch[0]);\n    cleanResponse = aiResponse.replace(jsonMatch[0], '').trim();\n  } catch (e) {\n    console.error('JSON parse hatasÄ±:', e);\n  }\n}\n\n// Ã–zel durumlarÄ± kontrol et\nconst specialCases = {\n  requiresHuman: metadata.requiresHuman || metadata.confidence < 0.3,\n  isComplaint: metadata.intent === 'COMPLAINT',\n  isOrder: metadata.intent === 'ORDER',\n  isUrgent: metadata.sentiment === 'negative' && metadata.confidence > 0.7\n};\n\n// YanÄ±t sÃ¼slemeleri\nif (specialCases.isUrgent) {\n  cleanResponse = 'ğŸ”´ ' + cleanResponse;\n}\n\n// Mesaj limitlerini kontrol et\nif (cleanResponse.length > 1000) {\n  cleanResponse = cleanResponse.substring(0, 997) + '...';\n}\n\nreturn [{json: {\n  response: cleanResponse,\n  metadata,\n  specialCases,\n  originalMessage: $('normalize-message').item.json\n}}];"
      },
      "id": "parse-response",
      "name": "ğŸ” YanÄ±tÄ± Ä°ÅŸle",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2520, 450]
    },

    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{$json.specialCases.requiresHuman}}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    }
                  }
                ]
              },
              "outputKey": "human"
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{$json.metadata.intent}}",
                    "rightValue": "ORDER",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              },
              "outputKey": "order"
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{$json.metadata.intent}}",
                    "rightValue": "COMPLAINT",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              },
              "outputKey": "complaint"
            }
          ]
        },
        "fallbackOutput": "standard"
      },
      "id": "route-response",
      "name": "ğŸ”€ YanÄ±t YÃ¶nlendirme",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [2720, 450]
    },

    {
      "parameters": {
        "content": "## ğŸ“¤ BÃ–LÃœM 4: YANITLAMA\n\n### Bu bÃ¶lÃ¼mÃ¼n gÃ¶revi:\nÃœretilen yanÄ±tlarÄ± platforma gÃ¶re gÃ¶ndermek\n\n### Platform Ã–zellikleri:\n\n#### WhatsApp:\n- âœ… Metin mesajlarÄ±\n- âœ… Interaktif butonlar\n- âœ… Liste mesajlarÄ±\n- âœ… Medya (resim, video, dosya)\n- âœ… Åablon mesajlarÄ±\n\n#### Instagram:\n- âœ… Metin mesajlarÄ±\n- âœ… HÄ±zlÄ± yanÄ±tlar\n- âœ… Medya paylaÅŸÄ±mÄ±\n- âš ï¸ SÄ±nÄ±rlÄ± interaktif Ã¶zellikler\n\n### Rate Limiting:\n- WhatsApp: 1000 mesaj/gÃ¼n\n- Instagram: 100 mesaj/saat\n\n### Hata YÃ¶netimi:\n- 3 deneme hakkÄ±\n- BaÅŸarÄ±sÄ±zlÄ±kta yedek mesaj\n- Hata loglamasÄ±",
        "height": 450,
        "width": 400
      },
      "id": "note-005",
      "name": "BÃ¶lÃ¼m 4 AÃ§Ä±klama",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [2900, 300]
    },

    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$('normalize-message').item.json.platform}}",
              "operation": "equals",
              "value2": "whatsapp"
            }
          ]
        }
      },
      "id": "if-whatsapp",
      "name": "WhatsApp mÄ±?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [3320, 420]
    },

    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v18.0/{{$env.META_WA_PHONE_ID}}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "messaging_product",
              "value": "whatsapp"
            },
            {
              "name": "to",
              "value": "={{$('normalize-message').item.json.userId}}"
            },
            {
              "name": "type",
              "value": "text"
            },
            {
              "name": "text",
              "value": "={\"body\": \"{{$('parse-response').item.json.response}}\"}"
            }
          ]
        },
        "options": {
          "timeout": 10000,
          "batching": {
            "batch": {
              "batchSize": 1
            }
          }
        }
      },
      "id": "send-whatsapp",
      "name": "ğŸ“± WhatsApp GÃ¶nder",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3520, 380]
    },

    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v18.0/{{$env.IG_BUSINESS_ID}}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "recipient",
              "value": "={\"id\": \"{{$('normalize-message').item.json.userId}}\"}"
            },
            {
              "name": "message",
              "value": "={\"text\": \"{{$('parse-response').item.json.response}}\"}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "send-instagram",
      "name": "ğŸ“¸ Instagram GÃ¶nder",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3520, 480]
    },

    {
      "parameters": {
        "content": "## ğŸ’¾ BÃ–LÃœM 5: VERÄ° KAYDI\n\n### Bu bÃ¶lÃ¼mÃ¼n gÃ¶revi:\nTÃ¼m etkileÅŸimleri kayÄ±t altÄ±na almak\n\n### Kaydedilen Veriler:\n\n#### 1. Mesaj KayÄ±tlarÄ±\n- Gelen/giden tÃ¼m mesajlar\n- Zaman damgasÄ±\n- Platform bilgisi\n- Intent ve sentiment\n\n#### 2. MÃ¼ÅŸteri Profili\n- Ä°letiÅŸim tercihleri\n- SatÄ±n alma geÃ§miÅŸi\n- Ã–zel notlar\n- Son etkileÅŸim\n\n#### 3. Performans Metrikleri\n- YanÄ±t sÃ¼releri\n- AI baÅŸarÄ± oranÄ±\n- MÃ¼ÅŸteri memnuniyeti\n- Destek yÃ¶nlendirmeleri\n\n### ğŸ“Š Raporlama:\n- GÃ¼nlÃ¼k Ã¶zet\n- HaftalÄ±k analiz\n- AylÄ±k trendler",
        "height": 450,
        "width": 400
      },
      "id": "note-006",
      "name": "BÃ¶lÃ¼m 5 AÃ§Ä±klama",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [3700, 300]
    },

    {
      "parameters": {
        "operation": "insert",
        "schema": "public",
        "table": "messages",
        "columns": "platform,user_id,direction,text,intent,created_at",
        "values": "={{$('normalize-message').item.json.platform}},={{$('normalize-message').item.json.userId}},in,={{$('normalize-message').item.json.content}},={{$('parse-response').item.json.metadata.intent}},={{new Date().toISOString()}}"
      },
      "id": "save-incoming",
      "name": "ğŸ’¾ Gelen MesajÄ± Kaydet",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [4120, 400]
    },

    {
      "parameters": {
        "operation": "insert",
        "schema": "public",
        "table": "messages",
        "columns": "platform,user_id,direction,text,intent,created_at",
        "values": "={{$('normalize-message').item.json.platform}},={{$('normalize-message').item.json.userId}},out,={{$('parse-response').item.json.response}},={{$('parse-response').item.json.metadata.intent}},={{new Date().toISOString()}}"
      },
      "id": "save-outgoing",
      "name": "ğŸ’¾ Giden MesajÄ± Kaydet",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [4120, 500]
    },

    {
      "parameters": {
        "operation": "upsert",
        "schema": "public",
        "table": "customer_memory",
        "columns": "user_id,preferences,notes,updated_at",
        "updateKey": "user_id",
        "values": "={{$('normalize-message').item.json.userId}},={{$('parse-response').item.json.metadata.intent}},Last interaction: {{$('parse-response').item.json.response.substring(0,100)}},={{new Date().toISOString()}}"
      },
      "id": "update-memory",
      "name": "ğŸ§  HafÄ±zayÄ± GÃ¼ncelle",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [4120, 600]
    },

    {
      "parameters": {
        "content": "## ğŸš¨ BÃ–LÃœM 6: DESTEK YÃ–NLENDÄ°RME\n\n### Bu bÃ¶lÃ¼mÃ¼n gÃ¶revi:\nKritik durumlarÄ± insan desteÄŸine yÃ¶nlendirmek\n\n### YÃ¶nlendirme Kriterleri:\n- AI gÃ¼ven skoru < 0.3\n- MÃ¼ÅŸteri Ã¶fkeli/sinirli\n- KarmaÅŸÄ±k teknik sorun\n- Ã–deme/iade talebi\n- 3+ kez aynÄ± soru\n\n### YÃ¶nlendirme SÃ¼reci:\n1. Destek talebi oluÅŸtur\n2. MÃ¼ÅŸteriye bilgi ver\n3. Destek ekibine bildirim\n4. Ticket numarasÄ± ata\n5. Takip et\n\n### Ã–ncelik Seviyeleri:\n- ğŸ”´ YÃœKSEK: Hemen\n- ğŸŸ¡ ORTA: 30 dakika\n- ğŸŸ¢ DÃœÅÃœK: 2 saat",
        "height": 400,
        "width": 400
      },
      "id": "note-007",
      "name": "BÃ¶lÃ¼m 6 AÃ§Ä±klama",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [2900, 800]
    },

    {
      "parameters": {
        "operation": "insert",
        "schema": "public",
        "table": "support_tickets",
        "columns": "user_id,issue,priority,status,created_at",
        "values": "={{$('normalize-message').item.json.userId}},={{$('normalize-message').item.json.content}},={{$json.metadata.sentiment === 'negative' ? 'high' : 'medium'}},open,={{new Date().toISOString()}}"
      },
      "id": "create-ticket",
      "name": "ğŸ« Destek Talebi OluÅŸtur",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [3320, 900]
    },

    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPPORT_TEAM_WEBHOOK}}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_id",
              "value": "={{$('normalize-message').item.json.userId}}"
            },
            {
              "name": "platform",
              "value": "={{$('normalize-message').item.json.platform}}"
            },
            {
              "name": "message",
              "value": "={{$('normalize-message').item.json.content}}"
            },
            {
              "name": "priority",
              "value": "={{$json.metadata.sentiment === 'negative' ? 'high' : 'medium'}}"
            },
            {
              "name": "ai_analysis",
              "value": "={{JSON.stringify($json.metadata)}}"
            }
          ]
        }
      },
      "id": "notify-support",
      "name": "ğŸ“¢ Destek Ekibine Bildir",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3520, 900]
    },

    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "message",
              "value": "ğŸ”„ MesajÄ±nÄ±z destek ekibimize iletildi. En kÄ±sa sÃ¼rede size dÃ¶nÃ¼ÅŸ yapacaÄŸÄ±z. Ticket No: #{{Math.floor(Math.random() * 10000)}}"
            }
          ]
        }
      },
      "id": "support-message",
      "name": "Destek MesajÄ± HazÄ±rla",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [3320, 1000]
    },

    {
      "parameters": {
        "responseBody": "OK",
        "responseCode": 200
      },
      "id": "final-response",
      "name": "âœ… Ä°ÅŸlem TamamlandÄ±",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [4320, 450]
    },

    {
      "parameters": {
        "content": "## ğŸ¯ PERFORMANS Ä°ZLEME\n\n### Metrikler:\n- â±ï¸ Ortalama yanÄ±t sÃ¼resi: < 2 saniye\n- ğŸ“Š AI baÅŸarÄ± oranÄ±: > %85\n- ğŸ˜Š MÃ¼ÅŸteri memnuniyeti: > 4.5/5\n- ğŸ”„ Otomasyon oranÄ±: > %70\n\n### Optimizasyon:\n- Cache kullanÄ±mÄ±\n- Batch processing\n- Async operations\n- Connection pooling",
        "height": 250,
        "width": 300
      },
      "id": "note-008",
      "name": "Performans",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [4500, 300]
    }
  ],
  "connections": {
    "ğŸ”“ Meta Webhook DoÄŸrulama": {
      "main": [[{"node": "Token DoÄŸru mu?", "type": "main", "index": 0}]]
    },
    "Token DoÄŸru mu?": {
      "main": [
        [{"node": "Challenge HazÄ±rla", "type": "main", "index": 0}],
        [{"node": "âŒ DoÄŸrulama BaÅŸarÄ±sÄ±z", "type": "main", "index": 0}]
      ]
    },
    "Challenge HazÄ±rla": {
      "main": [[{"node": "âœ… DoÄŸrulama BaÅŸarÄ±lÄ±", "type": "main", "index": 0}]]
    },
    "ğŸ“¥ Mesaj Webhook'u": {
      "main": [[{"node": "ğŸ”’ Ä°mza DoÄŸrulama", "type": "main", "index": 0}]]
    },
    "ğŸ”’ Ä°mza DoÄŸrulama": {
      "main": [[{"node": "Ä°mza GeÃ§erli mi?", "type": "main", "index": 0}]]
    },
    "Ä°mza GeÃ§erli mi?": {
      "main": [
        [{"node": "ğŸ”„ Mesaj Normalizasyon", "type": "main", "index": 0}],
        [{"node": "âœ… Ä°ÅŸlem TamamlandÄ±", "type": "main", "index": 0}]
      ]
    },
    "ğŸ”„ Mesaj Normalizasyon": {
      "main": [[{"node": "Ä°ÅŸlenecek Mesaj mÄ±?", "type": "main", "index": 0}]]
    },
    "Ä°ÅŸlenecek Mesaj mÄ±?": {
      "main": [
        [
          {"node": "ğŸ“œ GeÃ§miÅŸ MesajlarÄ± Al", "type": "main", "index": 0},
          {"node": "ğŸ§  MÃ¼ÅŸteri HafÄ±zasÄ±", "type": "main", "index": 0}
        ],
        [{"node": "âœ… Ä°ÅŸlem TamamlandÄ±", "type": "main", "index": 0}]
      ]
    },
    "ğŸ“œ GeÃ§miÅŸ MesajlarÄ± Al": {
      "main": [[{"node": "ğŸ“ AI BaÄŸlamÄ± HazÄ±rla", "type": "main", "index": 0}]]
    },
    "ğŸ§  MÃ¼ÅŸteri HafÄ±zasÄ±": {
      "main": [[{"node": "ğŸ“ AI BaÄŸlamÄ± HazÄ±rla", "type": "main", "index": 1}]]
    },
    "ğŸ“ AI BaÄŸlamÄ± HazÄ±rla": {
      "main": [[{"node": "ğŸ¤– AI YanÄ±t Ãœret", "type": "main", "index": 0}]]
    },
    "ğŸ¤– AI YanÄ±t Ãœret": {
      "main": [[{"node": "ğŸ” YanÄ±tÄ± Ä°ÅŸle", "type": "main", "index": 0}]]
    },
    "ğŸ” YanÄ±tÄ± Ä°ÅŸle": {
      "main": [[{"node": "ğŸ”€ YanÄ±t YÃ¶nlendirme", "type": "main", "index": 0}]]
    },
    "ğŸ”€ YanÄ±t YÃ¶nlendirme": {
      "main": [
        [
          {"node": "ğŸ« Destek Talebi OluÅŸtur", "type": "main", "index": 0},
          {"node": "ğŸ“¢ Destek Ekibine Bildir", "type": "main", "index": 0},
          {"node": "Destek MesajÄ± HazÄ±rla", "type": "main", "index": 0}
        ],
        [{"node": "WhatsApp mÄ±?", "type": "main", "index": 0}],
        [{"node": "WhatsApp mÄ±?", "type": "main", "index": 0}],
        [{"node": "WhatsApp mÄ±?", "type": "main", "index": 0}]
      ]
    },
    "WhatsApp mÄ±?": {
      "main": [
        [{"node": "ğŸ“± WhatsApp GÃ¶nder", "type": "main", "index": 0}],
        [{"node": "ğŸ“¸ Instagram GÃ¶nder", "type": "main", "index": 0}]
      ]
    },
    "ğŸ“± WhatsApp GÃ¶nder": {
      "main": [[
        {"node": "ğŸ’¾ Gelen MesajÄ± Kaydet", "type": "main", "index": 0},
        {"node": "ğŸ’¾ Giden MesajÄ± Kaydet", "type": "main", "index": 0},
        {"node": "ğŸ§  HafÄ±zayÄ± GÃ¼ncelle", "type": "main", "index": 0}
      ]]
    },
    "ğŸ“¸ Instagram GÃ¶nder": {
      "main": [[
        {"node": "ğŸ’¾ Gelen MesajÄ± Kaydet", "type": "main", "index": 0},
        {"node": "ğŸ’¾ Giden MesajÄ± Kaydet", "type": "main", "index": 0},
        {"node": "ğŸ§  HafÄ±zayÄ± GÃ¼ncelle", "type": "main", "index": 0}
      ]]
    },
    "ğŸ’¾ Gelen MesajÄ± Kaydet": {
      "main": [[{"node": "âœ… Ä°ÅŸlem TamamlandÄ±", "type": "main", "index": 0}]]
    },
    "ğŸ’¾ Giden MesajÄ± Kaydet": {
      "main": [[{"node": "âœ… Ä°ÅŸlem TamamlandÄ±", "type": "main", "index": 0}]]
    },
    "ğŸ§  HafÄ±zayÄ± GÃ¼ncelle": {
      "main": [[{"node": "âœ… Ä°ÅŸlem TamamlandÄ±", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "versionId": "pro-v2.0",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "chatbot-pro-v2",
  "tags": [
    {
      "name": "WhatsApp",
      "createdAt": "2024-01-01T00:00:00.000Z"
    },
    {
      "name": "Instagram",
      "createdAt": "2024-01-01T00:00:00.000Z"
    },
    {
      "name": "AI",
      "createdAt": "2024-01-01T00:00:00.000Z"
    },
    {
      "name": "Production",
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ]
}
