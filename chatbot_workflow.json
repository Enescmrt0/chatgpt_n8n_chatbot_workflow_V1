{
  "name": "WhatsApp + Instagram Chatbot ‚Äî Full, Annotated",
  "notesInFlow": true,
  "nodes": [
    {
      "parameters": {
        "path": "meta/verify",
        "methods": [
          "GET"
        ],
        "responseMode": "responseNode",
        "options": {
          "rawBody": true
        }
      },
      "name": "Webhook ‚Ä¢ Meta Verify (GET)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [220, 140],
      "notes": "Meta (WhatsApp/Instagram) webhook doƒürulama √ßaƒürƒ±sƒ±. Facebook, GET ile `hub.mode`, `hub.verify_token`, `hub.challenge` g√∂nderir. Bu node, 'Respond to Webhook' ile challenge'ƒ± geri d√∂nd√ºr√ºr. ENV: VERIFY_TOKEN kullanƒ±n."
    },
    {
      "parameters": {
        "responseBody": "={{$json[\"query\"][\"hub.challenge\"]}}",
        "responseCode": 200,
        "options": {}
      },
      "name": "Respond ‚Ä¢ Verify",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [540, 140],
      "notes": "Doƒürulama yanƒ±tƒ±. Eƒüer `hub.verify_token` yanlƒ±≈üsa 403 d√∂nmek i√ßin 'IF Verify Token' ile kontrol eklenmi≈ütir."
    },
    {
      "parameters": {
        "functionCode": "const valid = ($json.query?.['hub.verify_token'] || '') === ($env.VERIFY_TOKEN || '');\nif (!valid) {\n  return [{ json: { valid: false, challenge: $json.query?.['hub.challenge'] || '' } }];\n}\nreturn [{ json: { valid: true, challenge: $json.query?.['hub.challenge'] || '' } }];"
      },
      "name": "IF ‚Ä¢ Verify Token",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [380, 240],
      "notes": "Query parametre `hub.verify_token` ile ENV `VERIFY_TOKEN` e≈üle≈üiyor mu? Evetse 200, deƒüilse 403 d√∂nd√ºr."
    },
    {
      "parameters": {
        "responseBody": "Unauthorized",
        "responseCode": 403,
        "options": {}
      },
      "name": "Respond ‚Ä¢ 403",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [540, 240],
      "notes": "Yanlƒ±≈ü verify token durumunda 403."
    },

    {
      "parameters": {
        "path": "wa/in",
        "methods": ["POST"],
        "responseMode": "responseNode",
        "options": { "rawBody": true }
      },
      "name": "Webhook ‚Ä¢ WhatsApp (POST)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [220, 420],
      "notes": "WhatsApp Cloud API inbound. Meta, X-Hub-Signature-256 header ile imza g√∂nderir. Bu node 'Respond to Webhook' ile 200 d√∂necek."
    },
    {
      "parameters": {
        "path": "ig/in",
        "methods": ["POST"],
        "responseMode": "responseNode",
        "options": { "rawBody": true }
      },
      "name": "Webhook ‚Ä¢ Instagram (POST)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [220, 620],
      "notes": "Instagram Messaging inbound webhook. Aynƒ± doƒürulama ve imza kontrol mantƒ±ƒüƒ±."
    },

    {
      "parameters": {
        "functionCode": "// HMAC SHA-256 imza doƒürulama (Meta App Secret ile)\nconst crypto = require('crypto');\nconst appSecret = $env.META_APP_SECRET || '';\nconst signature = $json.headers?.['x-hub-signature-256'] || $json.headers?.['X-Hub-Signature-256'] || '';\nconst rawBody = $json.rawBody ? Buffer.from($json.rawBody) : Buffer.from(JSON.stringify($json.body||{}));\nconst expected = 'sha256=' + crypto.createHmac('sha256', appSecret).update(rawBody).digest('hex');\nconst valid = signature === expected;\nreturn [{ json: { valid, signature, expected } }];"
      },
      "name": "Security ‚Ä¢ Verify Signature",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [420, 520],
      "notes": "Meta imza doƒürulamasƒ±. ENV: META_APP_SECRET. Ge√ßersizse 403 d√∂nd√ºr."
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.valid}}"
            }
          ]
        }
      },
      "name": "IF ‚Ä¢ Signature OK?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [620, 520],
      "notes": "ƒ∞mza ge√ßerliyse devam, deƒüilse 403."
    },
    {
      "parameters": {
        "responseBody": "Invalid signature",
        "responseCode": 403,
        "options": {}
      },
      "name": "Respond ‚Ä¢ 403 (Sig)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [800, 600],
      "notes": "ƒ∞mza hatalƒ±ysa 403 d√∂ner."
    },

    {
      "parameters": {
        "functionCode": "// WhatsApp ve Instagram payload'unu normalize et\nconst body = $json.body || {};\nlet platform = 'whatsapp';\nif (($json.headers?.['x-meta-topic']||'').toLowerCase().includes('instagram') || (body.object||'').includes('instagram')) platform = 'instagram';\n\nlet entry = (body.entry && body.entry[0]) || {};\nlet change = (entry.changes && entry.changes[0]) || {};\nlet value = change.value || {};\n\n// WhatsApp\nlet waMsg = (value.messages && value.messages[0]) || null;\nlet waFrom = waMsg?.from || value?.contacts?.[0]?.wa_id || '';\nlet waText = waMsg?.text?.body || waMsg?.button?.text || waMsg?.interactive?.button_reply?.title || '' ;\nlet waBtnId = waMsg?.interactive?.button_reply?.id || null;\nlet waMsgId = waMsg?.id || null;\n\n// Instagram (Messaging webhook yapƒ±sƒ± farklƒ± olabilir; burada √∂rnek normalize)\nlet igMsg = (value.messaging && value.messaging[0] && value.messaging[0].message) || null;\nlet igFrom = (value.messaging && value.messaging[0] && value.messaging[0].sender && value.messaging[0].sender.id) || '';\nlet igText = igMsg?.text || '';\n\nconst out = {\n  platform,\n  from: platform==='whatsapp'? waFrom : igFrom,\n  text: platform==='whatsapp'? waText : igText,\n  ratingChoice: platform==='whatsapp'? waBtnId : null,\n  waMessageId: waMsgId || null,\n  raw: body,\n};\nreturn [{ json: out }];"
      },
      "name": "Transform ‚Ä¢ Normalize Event",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [820, 420],
      "notes": "Gelen webhook payload'unu tek formatta toplar: platform, from, text, ratingChoice, waMessageId."
    },

    {
      "parameters": {
        "operation": "insert",
        "table": "contacts",
        "columns": ["platform", "user_id"],
        "values": [
          "={{$json.platform}}",
          "={{$json.from}}"
        ]
      },
      "name": "DB ‚Ä¢ Upsert Contact",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1040, 360],
      "credentials": { "postgres": "ChatbotDB" },
      "notes": "contacts(platform, user_id, first_seen default now()). Eƒüer unique constraint varsa 'ignore duplicates' opsiyonunu DB seviyesinde kullanƒ±n."
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "messages",
        "columns": ["platform", "user_id", "direction", "text", "provider_msg_id"],
        "values": [
          "={{$json.platform}}",
          "={{$json.from}}",
          "in",
          "={{$json.text}}",
          "={{$json.waMessageId}}"
        ]
      },
      "name": "DB ‚Ä¢ Log Inbound Message",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1040, 460],
      "credentials": { "postgres": "ChatbotDB" },
      "notes": "M√º≈üteri mesajƒ± kaydƒ±. messages(direction: in/out)."
    },

    {
      "parameters": {
        "operation": "select",
        "table": "customer_memory",
        "columns": ["summary"],
        "where": "platform = :p AND user_id = :u",
        "values": { "p": "={{$json.platform}}", "u": "={{$json.from}}" },
        "options": { "limit": 1 }
      },
      "name": "DB ‚Ä¢ Fetch Memory",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1240, 360],
      "credentials": { "postgres": "ChatbotDB" },
      "notes": "Kullanƒ±cƒ±ya √∂zel √∂zet bellek (son tercihleri, √∂nemli ayrƒ±ntƒ±lar)."
    },
    {
      "parameters": {
        "operation": "select",
        "table": "messages",
        "columns": ["direction", "text"],
        "where": "platform = :p AND user_id = :u",
        "values": { "p": "={{$json.platform}}", "u": "={{$json.from}}" },
        "options": { "limit": 10, "orderBy": "created_at", "orderByDirection": "DESC" }
      },
      "name": "DB ‚Ä¢ Fetch Last 10 Msgs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1240, 460],
      "credentials": { "postgres": "ChatbotDB" },
      "notes": "Ge√ßmi≈ü konu≈ümadan son 10 mesaj. Prompt'a baƒülam olarak eklenir."
    },

    {
      "parameters": {
        "functionCode": "// Prompt bile≈üenlerini hazƒ±rla\nconst memory = $items("DB ‚Ä¢ Fetch Memory", 0, 0).json?.[0]?.summary || '';\nconst historyRows = $items("DB ‚Ä¢ Fetch Last 10 Msgs", 0, 0).json || [];\nconst history = historyRows.reverse().map(r => `${r.direction}: ${r.text}`).join('\n');\nconst userText = $items("Transform ‚Ä¢ Normalize Event", 0, 0).json.text;\nconst system = `Sen bir i≈ületme destek botusun. Her yanƒ±t kƒ±sa, net ve nazik olmalƒ±. Gerekirse sipari≈ü durumunu anlat, gerekirse not al. Elde varsa m√º≈üteri belleƒüini (tercihler, ge√ßmi≈ü) dikkate al.`;\nreturn [{ json: { system, memory, history, userText } }];"
      },
      "name": "AI ‚Ä¢ Build Prompt Context",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1440, 410],
      "notes": "Bellek + ge√ßmi≈ü konu≈üma + sistem talimatƒ±nƒ± birle≈ütirir."
    },

    {
      "parameters": {
        "operation": "chat",
        "model": "gpt-4o-mini",
        "temperature": 0,
        "messages": [
          { "role": "system", "content": "={{$json.system}}" },
          { "role": "system", "content": "M√º≈üteri belleƒüi: {{$json.memory}}" },
          { "role": "system", "content": "Ge√ßmi≈ü konu≈üma:\n{{$json.history}}" },
          { "role": "user", "content": "={{$json.userText}}" },
          { "role": "system", "content": "Cevabƒ±n SONUNA tek satƒ±rlƒ±k JSON ekle:\n{\"intent\": \"ORDER|RATING|FAQ|HANDOFF|OTHER\", \"confidence\": 0-1, \"order_id\": \"varsa\"}" }
        ]
      },
      "name": "AI ‚Ä¢ Classify + Draft Reply",
      "type": "n8n-nodes-base.openai",
      "typeVersion": 1,
      "position": [1660, 410],
      "credentials": { "openaiApi": "OpenAI Account" },
      "notes": "Yanƒ±t taslaƒüƒ± + niyet JSON'u (satƒ±r sonunda). temperature=0 ‚Üí tutarlƒ±lƒ±k."
    },
    {
      "parameters": {
        "functionCode": "// Mesaj sonundaki JSON'u ayƒ±kla\nconst content = $json.data?.choices?.[0]?.message?.content || '';\nconst match = content.match(/\{\"intent\"[\s\S]*\}$/);\nlet meta = { intent: 'OTHER', confidence: 0, order_id: ''};\nlet reply = content;\nif (match) {\n  try { meta = JSON.parse(match[0]); reply = content.replace(match[0], '').trim(); } catch(e) {}\n}\nreturn [{ json: { reply, meta } }];"
      },
      "name": "AI ‚Ä¢ Parse Intent JSON",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1860, 410],
      "notes": "Niyet JSON'unu √ßƒ±karƒ±r: intent, confidence, order_id. Kalanƒ± 'reply'."
    },

    {
      "parameters": {
        "propertyName": "={{$json.meta.intent}}",
        "rules": [
          { "operation": "equal", "value": "ORDER", "output": 1 },
          { "operation": "equal", "value": "RATING", "output": 2 },
          { "operation": "equal", "value": "HANDOFF", "output": 3 }
        ]
      },
      "name": "Route ‚Ä¢ Intent",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [2060, 410],
      "notes": "Intent'e g√∂re dallanƒ±r: ORDER / RATING / HANDOFF / default ‚Üí FAQ/OTHER."
    },

    {
      "parameters": {
        "functionCode": "// Mesajdan sipari≈ü numarasƒ± √ßƒ±kar (6+ haneli) veya meta.order_id kullan\nconst text = $items("Transform ‚Ä¢ Normalize Event", 0, 0).json.text || '';\nconst metaOrder = $items("AI ‚Ä¢ Parse Intent JSON", 0, 0).json.meta.order_id || '';\nconst m = text.match(/(\b\d{6,}\b)/);\nconst orderId = metaOrder || (m? m[1] : '');\nreturn [{ json: { orderId } }];"
      },
      "name": "Order ‚Ä¢ Extract ID",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2260, 300],
      "notes": "Regex ile sipari≈ü numarasƒ± tespiti. Yoksa bo≈ü d√∂ner."
    },
    {
      "parameters": {
        "operation": "select",
        "table": "orders",
        "columns": ["order_id", "status", "last_update"],
        "where": "order_id = :o",
        "values": { "o": "={{$json.orderId}}" },
        "options": { "limit": 1 }
      },
      "name": "Order ‚Ä¢ DB Lookup",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [2460, 260],
      "credentials": { "postgres": "ChatbotDB" },
      "notes": "orders tablosundan arar. Bulunamazsa API'ye sor."
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "options": { "retryOnFail": true, "maxRetries": 3, "retryWait": 1000 },
        "url": "={{$env.ORDER_API_BASE}}/orders/{{$json.orderId}}",
        "sendBody": false
      },
      "name": "Order ‚Ä¢ HTTP Lookup",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2460, 340],
      "credentials": { "httpHeaderAuth": "Order API Token" },
      "notes": "Dƒ±≈ü sipari≈ü servisinden √ßek (Bearer token credential olarak)."
    },
    {
      "parameters": {
        "functionCode": "// DB sonucu veya API sonucundan insan-dostu cevap hazƒ±rla\nconst dbRow = $items(\"Order ‚Ä¢ DB Lookup\", 0, 0).json?.[0] || null;\nconst apiRow = $items(\"Order ‚Ä¢ HTTP Lookup\", 0, 0).json || null;\nconst data = dbRow || apiRow || null;\nlet text = '';\nif (!($items(\"Order ‚Ä¢ Extract ID\", 0, 0).json.orderId)) {\n  text = 'Sipari≈ü numaranƒ±zƒ± payla≈üabilir misiniz? (√ñrn: 123456)';\n} else if (!data) {\n  text = `√úzg√ºn√ºm, ≈üu an ${$items(\"Order ‚Ä¢ Extract ID\", 0, 0).json.orderId} numaralƒ± sipari≈üi bulamadƒ±m. L√ºtfen numarayƒ± doƒürular mƒ±sƒ±nƒ±z?`;\n} else {\n  text = `Sipari≈ü #${data.order_id} durumunuz: ${data.status}. Son g√ºncelleme: ${data.last_update || '‚Äî'}`;\n}\nreturn [{ json: { reply: text } }];"
      },
      "name": "Order ‚Ä¢ Compose Reply",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2660, 300],
      "notes": "Kullanƒ±cƒ±ya g√∂sterilecek sipari≈ü yanƒ±tƒ±."
    },

    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "https://graph.facebook.com/v20.0/{{$env.META_WA_PHONE_ID}}/messages",
        "sendBody": true,
        "options": { "retryOnFail": true, "maxRetries": 3, "retryWait": 1000 },
        "jsonBody": {
          "messaging_product": "whatsapp",
          "to": "={{$items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.from}}",
          "type": "interactive",
          "interactive": {
            "type": "button",
            "body": { "text": "Hizmetimizi deƒüerlendirir misiniz?" },
            "action": {
              "buttons": [
                { "type": "reply", "reply": { "id": "rating_5", "title": "üëç √áok ƒ∞yi" } },
                { "type": "reply", "reply": { "id": "rating_3", "title": "üëå Orta" } },
                { "type": "reply", "reply": { "id": "rating_1", "title": "üëé K√∂t√º" } }
              ]
            }
          }
        }
      },
      "name": "Rating ‚Ä¢ Send WA Buttons",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2260, 480],
      "credentials": { "httpHeaderAuth": "Meta WhatsApp Cloud API" },
      "notes": "WhatsApp interaktif butonlarƒ± ile puanlama."
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "https://graph.facebook.com/v20.0/{{$env.IG_BUSINESS_ID}}/messages",
        "sendBody": true,
        "options": { "retryOnFail": true, "maxRetries": 3, "retryWait": 1000 },
        "jsonBody": {
          "recipient": { "id": "={{$items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.from}}" },
          "message": { "text": "L√ºtfen hizmetimizi 1-5 arasƒ± puanlayƒ±n (5=√áok iyi)." }
        }
      },
      "name": "Rating ‚Ä¢ IG Ask Text",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2460, 480],
      "credentials": { "httpHeaderAuth": "Meta Instagram Graph API" },
      "notes": "Instagram i√ßin metin tabanlƒ± puanlama y√∂nlendirmesi."
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "ratings",
        "columns": ["platform", "user_id", "value"],
        "values": [
          "={{$items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.platform}}",
          "={{$items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.from}}",
          "={{$items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.ratingChoice ? ($items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.ratingChoice === 'rating_5' ? 5 : ($items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.ratingChoice === 'rating_3' ? 3 : 1)) : null}}"
        ]
      },
      "name": "Rating ‚Ä¢ Save to DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [2660, 480],
      "credentials": { "postgres": "ChatbotDB" },
      "notes": "Buton se√ßimi geldiyse 5/3/1 puan olarak kaydeder. IG i√ßin metin rakamƒ± parse etmek √ºzere ek fonksiyon ekleyebilirsiniz."
    },

    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "https://graph.facebook.com/v20.0/{{$env.META_WA_PHONE_ID}}/messages",
        "sendBody": true,
        "options": { "retryOnFail": true, "maxRetries": 3, "retryWait": 1000 },
        "jsonBody": {
          "messaging_product": "whatsapp",
          "to": "={{$items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.from}}",
          "context": { "message_id": "={{$items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.waMessageId}}" },
          "type": "text",
          "text": { "body": "={{$json.reply}}" }
        }
      },
      "name": "Send ‚Ä¢ WhatsApp Reply",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2260, 680],
      "credentials": { "httpHeaderAuth": "Meta WhatsApp Cloud API" },
      "notes": "Standart metin yanƒ±tƒ±. context.message_id ile reply √∂zelliƒüi."
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "https://graph.facebook.com/v20.0/{{$env.IG_BUSINESS_ID}}/messages",
        "sendBody": true,
        "options": { "retryOnFail": true, "maxRetries": 3, "retryWait": 1000 },
        "jsonBody": {
          "recipient": { "id": "={{$items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.from}}" },
          "message": { "text": "={{$json.reply}}" }
        }
      },
      "name": "Send ‚Ä¢ Instagram Reply",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2460, 680],
      "credentials": { "httpHeaderAuth": "Meta Instagram Graph API" },
      "notes": "Instagram'a standart metin yanƒ±tƒ±."
    },

    {
      "parameters": {
        "operation": "insert",
        "table": "messages",
        "columns": ["platform", "user_id", "direction", "text"],
        "values": [
          "={{$items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.platform}}",
          "={{$items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.from}}",
          "out",
          "={{$json.reply}}"
        ]
      },
      "name": "DB ‚Ä¢ Log Outbound Message",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [2660, 680],
      "credentials": { "postgres": "ChatbotDB" },
      "notes": "G√∂nderilen yanƒ±tƒ± kaydeder."
    },

    {
      "parameters": {
        "operation": "chat",
        "model": "gpt-4o-mini",
        "temperature": 0.2,
        "messages": [
          { "role": "system", "content": "A≈üaƒüƒ±daki diyaloƒüu 1-3 c√ºmlede m√º≈üteri odaklƒ± kalƒ±cƒ± √∂zet olarak kaydet. Gereksiz ayrƒ±ntƒ±larƒ± √ßƒ±kar, tercih/niyet gibi bilgileri koru." },
          { "role": "user", "content": "Kullanƒ±cƒ±: {{$items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.text}}\nBot: {{$items(\"Send ‚Ä¢ WhatsApp Reply\", 0, 0).json.reply || $items(\"Send ‚Ä¢ Instagram Reply\", 0, 0).json.reply || $items(\"Order ‚Ä¢ Compose Reply\", 0, 0).json.reply}}" }
        ]
      },
      "name": "AI ‚Ä¢ Summarize Memory",
      "type": "n8n-nodes-base.openai",
      "typeVersion": 1,
      "position": [2860, 620],
      "credentials": { "openaiApi": "OpenAI Account" },
      "notes": "Kƒ±sa m√º≈üteri hafƒ±zasƒ± √ºretir."
    },
    {
      "parameters": {
        "operation": "upsert",
        "table": "customer_memory",
        "columns": ["platform", "user_id", "summary"],
        "updateKey": ["platform", "user_id"],
        "values": [
          "={{$items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.platform}}",
          "={{$items(\"Transform ‚Ä¢ Normalize Event\", 0, 0).json.from}}",
          "={{$json.data.choices[0].message.content}}"
        ]
      },
      "name": "DB ‚Ä¢ Upsert Memory",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [3060, 620],
      "credentials": { "postgres": "ChatbotDB" },
      "notes": "M√º≈üteri bazlƒ± √∂zet belleƒüi g√ºnceller."
    },

    {
      "parameters": {
        "responseBody": "ok",
        "responseCode": 200,
        "options": {}
      },
      "name": "Respond ‚Ä¢ 200 OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2860, 740],
      "notes": "Webhook √ßaƒürƒ±sƒ±nƒ± tamamlar (200)."
    }
  ],
  "connections": {
    "Webhook ‚Ä¢ Meta Verify (GET)": { "main": [[{ "node": "IF ‚Ä¢ Verify Token", "type": "main", "index": 0 }]] },
    "IF ‚Ä¢ Verify Token": {
      "main": [
        [{ "node": "Respond ‚Ä¢ Verify", "type": "main", "index": 0 }],
        [{ "node": "Respond ‚Ä¢ 403", "type": "main", "index": 0 }]
      ]
    },

    "Webhook ‚Ä¢ WhatsApp (POST)": { "main": [[{ "node": "Security ‚Ä¢ Verify Signature", "type": "main", "index": 0 }]] },
    "Webhook ‚Ä¢ Instagram (POST)": { "main": [[{ "node": "Security ‚Ä¢ Verify Signature", "type": "main", "index": 0 }]] },
    "Security ‚Ä¢ Verify Signature": { "main": [[{ "node": "IF ‚Ä¢ Signature OK?", "type": "main", "index": 0 }]] },
    "IF ‚Ä¢ Signature OK?": {
      "main": [
        [{ "node": "Transform ‚Ä¢ Normalize Event", "type": "main", "index": 0 }],
        [{ "node": "Respond ‚Ä¢ 403 (Sig)", "type": "main", "index": 0 }]
      ]
    },

    "Transform ‚Ä¢ Normalize Event": { "main": [[{ "node": "DB ‚Ä¢ Upsert Contact", "type": "main", "index": 0 }]] },
    "DB ‚Ä¢ Upsert Contact": { "main": [[{ "node": "DB ‚Ä¢ Log Inbound Message", "type": "main", "index": 0 }]] },
    "DB ‚Ä¢ Log Inbound Message": { "main": [[{ "node": "DB ‚Ä¢ Fetch Memory", "type": "main", "index": 0 }, { "node": "DB ‚Ä¢ Fetch Last 10 Msgs", "type": "main", "index": 0 }]] },
    "DB ‚Ä¢ Fetch Memory": { "main": [[{ "node": "AI ‚Ä¢ Build Prompt Context", "type": "main", "index": 0 }]] },
    "DB ‚Ä¢ Fetch Last 10 Msgs": { "main": [[{ "node": "AI ‚Ä¢ Build Prompt Context", "type": "main", "index": 0 }]] },
    "AI ‚Ä¢ Build Prompt Context": { "main": [[{ "node": "AI ‚Ä¢ Classify + Draft Reply", "type": "main", "index": 0 }]] },
    "AI ‚Ä¢ Classify + Draft Reply": { "main": [[{ "node": "AI ‚Ä¢ Parse Intent JSON", "type": "main", "index": 0 }]] },
    "AI ‚Ä¢ Parse Intent JSON": { "main": [[{ "node": "Route ‚Ä¢ Intent", "type": "main", "index": 0 }]] },

    "Route ‚Ä¢ Intent": {
      "main": [
        [{ "node": "Order ‚Ä¢ Extract ID", "type": "main", "index": 0 }],
        [{ "node": "Rating ‚Ä¢ Send WA Buttons", "type": "main", "index": 0 }, { "node": "Rating ‚Ä¢ IG Ask Text", "type": "main", "index": 0 }],
        [{ "node": "Send ‚Ä¢ WhatsApp Reply", "type": "main", "index": 0 }, { "node": "Send ‚Ä¢ Instagram Reply", "type": "main", "index": 0 }]
      ]
    },
    "Order ‚Ä¢ Extract ID": { "main": [[{ "node": "Order ‚Ä¢ DB Lookup", "type": "main", "index": 0 }, { "node": "Order ‚Ä¢ HTTP Lookup", "type": "main", "index": 0 }]] },
    "Order ‚Ä¢ DB Lookup": { "main": [[{ "node": "Order ‚Ä¢ Compose Reply", "type": "main", "index": 0 }]] },
    "Order ‚Ä¢ HTTP Lookup": { "main": [[{ "node": "Order ‚Ä¢ Compose Reply", "type": "main", "index": 0 }]] },

    "Order ‚Ä¢ Compose Reply": { "main": [[{ "node": "Send ‚Ä¢ WhatsApp Reply", "type": "main", "index": 0 }, { "node": "Send ‚Ä¢ Instagram Reply", "type": "main", "index": 0 }]] },

    "Send ‚Ä¢ WhatsApp Reply": { "main": [[{ "node": "DB ‚Ä¢ Log Outbound Message", "type": "main", "index": 0 }, { "node": "AI ‚Ä¢ Summarize Memory", "type": "main", "index": 0 }, { "node": "Respond ‚Ä¢ 200 OK", "type": "main", "index": 0 }]] },
    "Send ‚Ä¢ Instagram Reply": { "main": [[{ "node": "DB ‚Ä¢ Log Outbound Message", "type": "main", "index": 0 }, { "node": "AI ‚Ä¢ Summarize Memory", "type": "main", "index": 0 }, { "node": "Respond ‚Ä¢ 200 OK", "type": "main", "index": 0 }]] },

    "Rating ‚Ä¢ Send WA Buttons": { "main": [[{ "node": "Rating ‚Ä¢ Save to DB", "type": "main", "index": 0 }]] },
    "Rating ‚Ä¢ IG Ask Text": { "main": [[{ "node": "Rating ‚Ä¢ Save to DB", "type": "main", "index": 0 }]] },

    "AI ‚Ä¢ Summarize Memory": { "main": [[{ "node": "DB ‚Ä¢ Upsert Memory", "type": "main", "index": 0 }]] }
  },
  "active": false,
  "settings": {},
  "pinData": {}
}
